define(["require","util","model.dragAndDrop"],function(require){function dragDrop(item,index){if(window.dropZone=="rearrangeablelist"){var group,draggedNode=this.node.childNodes[index];util.hasClass(draggedNode,"selected")?group=this.selectedNodes:group=[draggedNode],this.onmoved(index),moveTo.call(this,group,item,window.dropRegion),window.dropRegion=undefined}util.removeNode(document.getElementById("dropIndicator"))}function dragWhileEntered(item,e){clearTimeout(window.dropLeaveTimeout),item=item.parentNode.parentNode;if(item instanceof HTMLLIElement){var region=window.dropRegion=cursorRegion(item,e),indicator=document.getElementById("dropIndicator"),index=Array.prototype.indexOf.call(this.node.childNodes,item);if(!indicator)var indicator=util.createElement({tag:"div",id:"dropIndicator",appendTo:this.node});region=="top"?indicator.style.top=index*25+"px":indicator.style.top=index*25+25+"px",window.dropIndex=region=="bottom"?index+1:index}}function dragLeave(){window.dropIndex=null,window.dropLeaveTimeout=window.setTimeout(function(){var indicator=document.getElementById("dropIndicator");indicator&&util.removeNode(indicator)},100)}function moveTo(group,moveTo,direction){if(direction=="bottom")for(var i=group.length-1;i>=0;i--)this.node.insertBefore(group[i],moveTo.nextSibling);else for(var i=0;i<group.length;i++)this.node.insertBefore(group[i],moveTo)}function cursorRegion(node,e){var distance=0,_node=node;do distance+=node.offsetTop,node=node.offsetParent;while(node);distance-=_node.parentNode.parentNode.scrollTop;var range=[distance,distance+_node.offsetHeight/2];return e.clientY>=range[0]&&e.clientY<=range[1]?"top":"bottom"}function selectionify(node){var self=this;util.addListener(node,"click",function(e){var clickedIndex=Array.prototype.indexOf.call(self.node.childNodes,node),selectedIndex=closestIndex(node,"selected");if(e.shiftKey&&selectedIndex!==-1){var range=[selectedIndex,clickedIndex].sort(function(a,b){return a-b});for(var i=range[0];i<=range[1];i++)util.addClass(self.node.childNodes[i],"selected"),self.selectedNodes.indexOf(self.node.childNodes[i])===-1&&self.selectedNodes.push(self.node.childNodes[i])}else!e.metaKey&&!e.ctrlKey&&clearSelectedItems.call(self),util.hasClass(node,"selected")?util.hasClass(node,"selected")&&(e.metaKey||e.ctrlKey)&&(util.removeClass(node,"selected"),self.selectedNodes.splice(self.selectedNodes.indexOf(node),1)):(self.selectedNodes.push(node),util.addClass(node,"selected"))})}function closestIndex(node,className){var list=node.parentNode,clickedIndex=Array.prototype.indexOf.call(list.childNodes,node),matchedIndex=-1;for(var i=clickedIndex;i>=0;i--)if(util.hasClass(list.childNodes[i],className)&&i!==clickedIndex){matchedIndex=i;break}if(matchedIndex==-1)for(var i=clickedIndex;i<list.childNodes.length;i++)if(util.hasClass(list.childNodes[i],className)&&i!==clickedIndex){matchedIndex=i;break}return matchedIndex}function clearSelectedItems(){util.forEach(this.selectedNodes,function(node){util.removeClass(node,"selected")}),this.selectedNodes.splice(0,this.selectedNodes.length)}var util=require("util"),DnD=require("model.dragAndDrop");util.registerStylesheet("./stylesheets/ui.widget.rearrangeableList.css");var RearrangeableList=function(options){this.node=util.createElement({tag:"ol",customClass:"UIRearrangeableListWidget",appendTo:options.appendTo instanceof Element?options.appendTo:document.body}),this.onmoved=options.onmoved,this.onnoderemoved=options.onnoderemoved,this.selectedNodes=[]};return RearrangeableList.prototype.addNodes=function(items,afterItem){var self=this;util.forEach(items,function(item){DnD.draggable({node:item,dropZone:"rearrangeablelist",start:function(){return Array.prototype.indexOf.call(self.node.childNodes,item)}}),DnD.droppable({node:item,dropZone:"rearrangeablelist",whileentered:function(target,e){dragWhileEntered.call(self,target,e)},leave:function(target){dragLeave()},drop:function(target,e,index){dragDrop.call(self,item,index)}}),selectionify.call(self,item),afterItem instanceof Element?afterItem.parentNode.insertBefore(item,afterItem):self.node.appendChild(item)})},RearrangeableList.prototype.removeNodesByIndex=function(group){if(group instanceof Array&&/^\d+$/.test(group.join(""))){group=group.sort(function(a,b){return a+b});for(var i=0;i<group.length;i++)this.onnoderemoved(i),util.removeNode(this.node.childNodes[group[i]])}},RearrangeableList.prototype.removeNodes=function(group){for(var i=0;i<group.length;i++)this.onnoderemoved(Array.prototype.indexOf.call(this.node.childNodes,group[i])),util.removeNode(group[i])},RearrangeableList.prototype.removeChildren=function(){util.removeChildren(this.node)},RearrangeableList})
define(["util"],function(util){function isValidMDD(MDD){if(typeof MDD=="object"&&!(MDD instanceof Array)){if(!MDD.title||!MDD.body)return!1;if(MDD.isWizardDialogue){if(!MDD.buttons)return!1;if(!MDD.buttons.next&&!MDD.buttons.prev&&!MDD.buttons.close)return!1}if(MDD.form)if(!MDD.form.name||!MDD.form.inputs)return!1;return!0}}util.registerStylesheet("./stylesheets/ui.widget.modalDialogue.css"),util.browser.isMobile&&util.registerStylesheet("./stylesheets/ui.widget.modalDialogue.mobile.css");var overlay=document.getElementById("ModalDialogueOverlay")?document.getElementById("ModalDialogueOverlay"):util.createElement({tag:"div",id:"ModalDialogueOverlay",appendTo:document.body}),currentDialogues={},Animator,AnimationPrefix=util.browser.hasSupport.cssTransitions,animateIn,animateOut,dialogueFromMDD=function(MDD){var self=this;this.MDD=MDD;if(isValidMDD(MDD)){var dialogue=this.dialogue=util.createElement({tag:"div",id:MDD.customId||"ModalDialogue",customClass:"visible"});MDD.errorDialogue==1&&util.addClass(dialogue,"error"),MDD.alignment&&/^(center|right|justify)$/.test(MDD.alignment)&&util.addClass(dialogue,MDD.alignment);var title=util.createElement({tag:"h1",inner:MDD.title,appendTo:dialogue});return this.createBody(MDD.body),MDD.form&&this.createForm(MDD.form),MDD.buttons&&this.createButtons(MDD.buttons,MDD),MDD.customClass&&util.addClass(dialogue,MDD.customClass),dialogue}throw new Error("Invalid Modal Dialogue Definiion.","MDD_ERR")};dialogueFromMDD.prototype.createBody=function(body){var self=this;body instanceof Array||(body=[body]),util.forEach(body,function(bodyPart){typeof bodyPart=="object"&&bodyPart instanceof Element?self.dialogue.appendChild(bodyPart):typeof bodyPart=="string"&&(/\<.+\>.*\<.+\>/.test(bodyPart)||(bodyPart="<p>"+bodyPart+"</p>"),self.dialogue.innerHTML+=bodyPart)})},dialogueFromMDD.prototype.createForm=function(form){var formElement=util.createElement({tag:"form",appendTo:this.dialogue,attributes:{name:form.name,method:"post"}}),inputs=[];util.forEach(form.inputs,function(input,index){if(input.title)var label=util.createElement({tag:"label",inner:input.title});if(input.type&&input.type=="select"){var element=util.createElement({tag:"select",attributes:{name:input.name}});util.forEach(input.options,function(option){var optionNode=util.createElement({tag:"option",inner:option,appendTo:element,attributes:{value:option}});input.placeholder&&option==input.placeholder&&optionNode.setAttribute("selected","selected")})}else if(input.type&&input.type=="button"&&typeof input.callback=="function"){var element=util.createElement({tag:"button",inner:input.name});util.addListener(element,"click",input.callback)}else{var element=util.createElement({tag:"input",attributes:{name:input.name||form.name+"-"+index,type:input.type||"text"}});input.type=="checkbox"&&(element.checked=input.checked||!1)}input.placeholder&&input.type!=="select"&&("placeholder"in element?element.setAttribute("placeholder",input.placeholder):require(["model.placeholder"],function(Placeholder){new Placeholder(element,input.placeholder)})),label?(label.appendChild(element),formElement.appendChild(label)):formElement.appendChild(element),inputs.push(element),form.callback&&util.addListener(element,"keyup",function(e){e.keyCode===13&&form.callback.call(ModalDialogue,inputs)})}),typeof form.callback=="function"&&(this.MDD.buttons=this.MDD.buttons||{},this.MDD.buttons[form.buttonTitle||"Submit"]=function(){form.callback.call(ModalDialogue,inputs)}),this.dialogue.appendChild(formElement)};var ModalDialogueButton=function(name,callback,context){var button=util.createElement({tag:"button",inner:name});return util.addListener(button,"click",function(callback,context){return function(e){callback.call(context||ModalDialogue,e)}}(callback,context)),button};dialogueFromMDD.prototype.createButtons=function(buttons,buttonContainer){var buttonContainer=buttonContainer instanceof Element?buttonContainer:util.createElement({tag:"div",customClass:"buttons",appendTo:this.dialogue});for(var i in buttons){var name,callback,self=this;typeof buttons[i]=="function"?(name=i,callback=buttons[i]):typeof buttons[i]=="object"?(name=buttons[i].title||buttons[i].name,callback=buttons[i].callback):typeof buttons[i]=="boolean"&&/close/i.test(i)&&(name="Close",callback=function(){ModalDialogue.close()});var context=typeof buttons[i].context=="object"?buttons[i].context:ModalDialogue,button=ModalDialogueButton(name,callback,context);button&&buttonContainer.appendChild(button)}};var ModalDialogue={};return ModalDialogue.createSingle=function(MDD){animateIn=MDD.animate&&MDD.animate.animateIn?MDD.animate.animateIn:null,animateOut=MDD.animate&&MDD.animate.animateOut?MDD.animate.animateOut:null;var dialogue=new dialogueFromMDD(MDD);return this.open(dialogue)},ModalDialogue.createWizard=function(dialogues,animate){var index=0;return animateIn=animate&&typeof animate.animateIn!="undefined"?animate.animateIn:null,animateOut=animate&&typeof animate.animateOut!="undefined"?animate.animateOut:null,util.forEach(dialogues,function(dialogue,i){if(dialogue.buttons)for(var j in dialogue.buttons){if(!/(prev|next)/i.test(j)||typeof dialogue.buttons[j]!="boolean")continue;dialogue.buttons[j]={name:j=="prev"?"Previous":"Next",callback:function(name){return function(){util.removeNode(currentDialogue),index=name=="prev"?index-1:index+1,currentDialogue=dialogues[index],overlay.appendChild(currentDialogue)}}(j)}}dialogues[i]=new dialogueFromMDD(dialogue)}),this.open(dialogues[0])},ModalDialogue.createMultiView=function(MVD){if(typeof MVD!="object")return!1;animateIn=MVD.animate&&typeof MVD.animate.animateIn!="undefined"?MVD.animate.animateIn:null,animateOut=MVD.animate&&typeof MVD.animate.animateOut!="undefined"?MVD.animate.animateOut:null;var NavigationItem=function(name,index,callback,context){var item=util.createElement({tag:"li",inner:name,attributes:{"data-viewIndex":index}});return util.addListener(item,"click",function(){return function(){callback.call(callback||window,index)}}()),index===0&&util.addClass(item,"active"),item},switchView=function(i){util.removeClass(navItems[index],"active"),index=i,util.addClass(navItems[index],"active"),util.removeNode(currentView),currentView=views[i],viewContainer.appendChild(currentView)},dialogue,navigation,navItems=[],navigationList,viewContainer,currentView,title,buttonContainer,views=[],index=0,self=this;dialogue=util.createElement({tag:"div",id:"ModalDialogue",customClass:"sidebar"}),navigation=util.createElement({tag:"div",customClass:"navigation",appendTo:dialogue}),viewContainer=util.createElement({tag:"div",customClass:"views",appendTo:dialogue}),typeof MVD.title=="string"&&(title=util.createElement({tag:"h1",inner:MVD.title,appendTo:navigation})),navigationList=util.createElement({tag:"ol",appendTo:navigation}),typeof MVD.buttons=="object"&&(buttonContainer=util.createElement({tag:"div",customClass:"buttons",appendTo:viewContainer}),dialogueFromMDD.prototype.createButtons(MVD.buttons,buttonContainer));if(MVD.views instanceof Array)return util.forEach(MVD.views,function(MDD,i){if(!isValidMDD(MDD))throw new Error("Invalid MDD - "+i);MDD.buttons&&delete MDD.buttons,MDD.form&&MDD.form.callback&&delete MDD.form.callback,MDD.customId="ModalView"+(i+1),MDD.customClass="view",views.push(new dialogueFromMDD(MDD));var navItem=NavigationItem(MDD.navTitle||MDD.title,i,switchView,ModalDialogue);navItems.push(navItem),navigationList.appendChild(navItem)}),currentView=views[0],viewContainer.appendChild(currentView),this.open(dialogue,MVD.animate&&MVD.animate.animateIn);throw new Error("The MutiView Definition does not have any views.")},ModalDialogue.close=function(id){if(currentDialogues[id]){if(!currentDialogues[id])return!1;AnimationPrefix&&animateOut?(new Animator(overlay,"fadeOut",.5),new Animator(currentDialogues[id],animateOut,.5,function(){util.removeNode(currentDialogues[id]),util.removeClass(overlay,"visible"),delete currentDialogues[id]})):(util.removeNode(currentDialogues[id]),util.removeClass(overlay,"visible"),delete currentDialogues[id])}else for(var i in currentDialogues)AnimationPrefix&&animateOut?(new Animator(overlay,"fadeOut",.5),new Animator(currentDialogues[i],animateOut,.5,function(){util.removeNode(currentDialogues[i]),util.removeClass(overlay,"visible"),delete currentDialogues[i]})):(util.removeNode(currentDialogues[i]),util.removeClass(overlay,"visible"),delete currentDialogues[i]);animateIn=animateOut=undefined},ModalDialogue.open=function(dialogue){function open(UIAnimator){UIAnimator&&(Animator=UIAnimator),overlay.appendChild(dialogue),util.addClass(overlay,"visible"),new Animator(overlay,"fadeIn",.5),new Animator(dialogue,animateIn,.5)}util.removeChildren(overlay);var dialogueId=(new Date).getTime();return currentDialogues[dialogueId]=dialogue,AnimationPrefix&&animateIn?Animator?open():require(["model.animator"],open):(overlay.appendChild(dialogue),util.addClass(overlay,"visible")),dialogueId},ModalDialogue.hasDialogue=function(id){if(id)return!!currentDialogues[id];var n=0;for(var i in currentDialogues)currentDialogues.hasOwnProperty(i)&&n++;return!!n},ModalDialogue})
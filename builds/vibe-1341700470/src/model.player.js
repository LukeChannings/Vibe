define(["util"],function(util){var currentSound=null,Player=function(options){var options=options||{},self=this;if(!options.withSettings)throw new Error("Missing settings instance.");this.settings=options.withSettings;if(!options.withPlaylistModel)throw new Error("Missing model playlist instance.");this.playlistModel=options.withPlaylistModel;if(!options.withUI)throw new Error("Missing player interface instance.");this.playerInterface=options.withUI,this.isMuted=!1,this.isPlaying=!1,this.isPaused=!1,this.volume=typeof this.settings.get("volume")=="number"?this.settings.get("volume"):70,this.playerInterface.onplaytoggle=function(button){self.playToggle(button)},this.playerInterface.onskip=function(direction){self.skip(direction)},this.playerInterface.onseek=function(position){self.seek(position)},options.onload&&options.onload(self)};return Player.prototype.addSound=function(id,autoplay){currentSound&&currentSound.hasOwnProperty("destruct")&&currentSound.destruct();var sound={id:id,url:"http://"+this.settings.get("host")+":"+this.settings.get("port")+"/stream/"+id,autoPlay:!!autoplay||!1,autoLoad:!0,stream:!0,volume:this.volume};util.augment(sound,this.Events,this),currentSound=this.currentSound=soundManager.createSound(sound);var duration=this.playlistModel.model[this.playlistModel.index].tracklength;return currentSound.realDuration=Math.floor(duration*1e3),this.playerInterface.playerSlider.updateDuration(duration),currentSound},Player.prototype.Events=function(){return this.onplay=this.onresume=function(){this.isPaused=!1,this.isPlaying=!0,util.addClass(this.playerInterface.controls.buttons.buttons.play_pause.node,"pause"),this.onplay&&this.onplay()},this.onpause=function(){this.isPaused=!0,this.isPlaying=!1,util.removeClass(this.playerInterface.controls.buttons.buttons.play_pause.node,"pause"),this.onpause&&this.onpause()},this.onstop=function(){console.log("stop"),this.isPlaying=!1,this.isPaused=!1,this.playerInterface.playerSlider.updateDuration(0),this.playerInterface.playerSlider.updateProgress(0,0),this.playerInterface.playerSlider.updateBuffer(0),util.removeClass(this.playerInterface.controls.buttons.buttons.play_pause.node,"pause"),this.onstop&&this.onstop()},this.onfinish=function(){this.isPlaying=!1,this.isPaused=!1,this.skip(1),this.onend&&this.onend()},this.whileplaying=function(){var progress=this.currentSound.position,duration=this.currentSound.realDuration;this.playerInterface.playerSlider.updateProgress(progress/duration,progress/1e3)},this.whileloading=function(){this.playerInterface.playerSlider.updateBuffer(this.currentSound.bytesLoaded/this.currentSound.bytesTotal*100)},this}.call({}),Player.prototype.skip=function(direction){var playlistModel=this.playlistModel,playlistInterface=playlistModel.ui,model=playlistModel.model,index=playlistModel.index+direction;playingNode=undefined,playlistInterface.playingNode?playingNode=direction==-1?playlistInterface.playingNode.previousSibling:playlistInterface.playingNode.nextSibling:(playingNode=playlistInterface.list.node.firstChild,index=0),playlistModel.setIndex(index,playingNode),model[index]?this.addSound(model[index].trackid,!0):(currentSound&&currentSound.destruct(),currentSound=this.currentSound=undefined,this.Events.onstop.call(this))},Player.prototype.play=function(){currentSound?currentSound.play():(this.playlistModel.setIndex(0,this.playlistModel.ui.list.node.firstChild),util.addClass(this.playlistModel.ui.playingNode,"playing"),this.addSound(this.playlistModel.getItem().trackid,!0))},Player.prototype.mute=function(){this.isMuted=!0,currentSound.mute()},Player.prototype.unMute=function(){this.isMuted=!1,currentSound.unmute()},Player.prototype.setVolume=function(n){this.volume=n,this.settings.set("volume",n),currentSound&&currentSound.setVolume(n)},Player.prototype.playToggle=function(button){this.isPlaying?currentSound.pause():this.play()},Player.prototype.seek=function(position){currentSound.setPosition(position*currentSound.realDuration)},Player})
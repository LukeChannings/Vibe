define(["require","util","ui.widget.treeList","model.dragAndDrop","ui.collection.searchBar"],function(require){var util=require("util"),TreeList=require("ui.widget.treeList"),DnD=require("model.dragAndDrop"),CollectionSearchBar=require("ui.collection.searchBar"),Collection=function(options){var api,type,node,self=this;options.onload&&(this.onload=options.onload),options.onitemselect&&(this.onitemselect=options.onitemselect),options.ondatadrop&&(this.ondatadrop=options.ondatadrop),options.onerror&&(this.onerror=options.onerror);if(!options.hasOwnProperty("withApi"))throw new Error("Collection options does not have property withApi.");api=this.api=options.withApi,util.registerStylesheet("./stylesheets/ui.collection.css",function(){type=self.type=options.withRootType||"artist",node=self.node=util.createElement({tag:"div",id:"UICollection"}),this.clickTimeout=options.clickTimeout?options.clickTimeout:270;var searchBar=self.searchBar=new CollectionSearchBar({appendTo:node,apiInstance:api,onclear:function(){util.removeClass(self.node,"noResults"),self.populateWithType(type)},onnoresult:function(){util.removeChildren(self.listContainer),util.addClass(self.node,"noResults")},onresult:function(result){console.log(result)}});self.listContainer=util.createElement({tag:"div",customClass:"listContainer",appendTo:self.node}),self.populateWithType(self.type),initInfoBar.call(self),options.dragAndDropElement instanceof Element&&(self.dropTarget=options.dragAndDropElement,initDragAndDrop.call(self)),typeof options.onload=="function"&&options.onload(self)})};Collection.prototype.populateWithType=function(type){var self=this;if(!/(genre|album|artist|track)/i.test(type))throw new Error("Unrecognised type.");this.api["get"+type[0].toUpperCase()+type.slice(1)+"s"](function(data){type=type.toLowerCase(),type=="genre"?util.forEach(data,function(genre){genre.name=genre.genre,genre.id=encodeURIComponent(genre.genre),delete genre.genre}):type=="album"&&util.forEach(data,function(album){album.setAttributes={"data-albumart":album.art_medium},util.cacheImage(album.art_medium)}),util.removeChildren(self.listContainer);var options={appendTo:self.listContainer,isRootNode:!0,isRootListener:!0,customClass:type,setAttributes:[]};self.dropTarget&&(options.dragStart=self.dragStart),options.onclick=function(item,isPopulated){clickHandler.call(self,item,isPopulated)},options.ondblclick=function(item){doubleClickHandler.call(self,item)};var list=new TreeList(data,options,self.clickTimeout);self.updateStatusBar(type,data.length)})};var initDragAndDrop=function(){var self=this;util.cacheImage("./images/ui.collection.genericAlbumArt.png"),util.cacheImage("./images/ui.collection.genericArtistArt.png"),this.dragStart=function(target,e){e.dataTransfer.dropEffect="copy";var type=target.parentNode.className.match(/(genre|artist|album|track)/)[0],id=target.getAttribute("data-id");if(e.dataTransfer.setDragImage){var DragImage=new Image,url=type=="artist"||type=="genre"?"./images/ui.collection.genericArtistArt.png":target.getAttribute("data-albumart")?target.getAttribute("data-albumart"):target.parentNode.parentNode.getAttribute("data-albumart")?target.parentNode.parentNode.getAttribute("data-albumart"):"./images/ui.collection.genericAlbumArt.png";return url=url=="null"?"./images/ui.collection.genericAlbumArt.png":url,DragImage.src=url,e.dataTransfer.setDragImage(DragImage,-10,-10),{id:id,type:type}}},DnD.droppable({node:this.dropTarget,zoneClass:"draghighlight",zoneHighlightNode:this.dropTarget,dropZone:"collection_playlist",drop:function(target,e,data){if(typeof data=="object")self.onitemselect(data);else{var data=[];for(var i=0;i<e.dataTransfer.files.length;i++){var reader=new FileReader,type=e.dataTransfer.files[i].type;reader.readAsDataURL(e.dataTransfer.files[i]),reader.onloadend=function(e){data.push({type:type,data:e.currentTarget.result.replace("data:"+type+"base64,","")})}}self.ondatadrop(data)}}})},initInfoBar=function(){util.addClass(this.node,"useInfo");var statusBar=this.statusBar=util.createElement({tag:"div",children:[{tag:"span"}],customClass:"statusBar",appendTo:this.node});this.updateStatusBar=function(type,itemCount){statusBar.getElementsByTagName("span")[0].innerHTML=itemCount+" "+type.charAt(0).toUpperCase()+type.slice(1),itemCount>1&&(statusBar.getElementsByTagName("span")[0].innerHTML+="s")}},clickHandler=function(item,isPopulated){var self=this;if(!isPopulated){var id=item.getAttribute("data-id"),type=item.parentNode.getAttribute("class").match(/(genre|artist|album|track)/);type=type[0]?type[0]:"artist";var options={appendTo:item,customClass:this.api.getSubtype(type),setAttributes:[]};options.customClass=="track"&&(options.isFinalNode=!0),this.dropTarget&&(options.setAttributes.push(["draggable","true"]),options.dragStartMethod=self.dragStart),this.api.getMethod(type,!0)?this.api[this.api.getMethod(type,!0)](id,function(items){type=="artist"&&util.forEach(items,function(album){album.title=album.title||"Unknown Album",album.setAttributes={"data-albumart":album.art_medium},util.cacheImage(album.art_medium)}),new TreeList(items,options,self.clickTimeout)},!0):this.onitemselected({type:type,id:id})}},doubleClickHandler=function(item){this.onitemselect({id:item.getAttribute("data-id"),type:item.parentNode.getAttribute("class").match(/(genre|artist|album|track)/)[0]})};return Collection})
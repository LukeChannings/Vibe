define(["lib/md5","model.persistence"],function(MD5,Persistence){var UndoManager=function(persistence){this.versions=[[]],this.currentVersion=0,this.store={},this.persistence=!1;var self=this,mutators=["push","splice","pop","shift","unshift","reverse","sort"],array=[];for(var i=0;i<mutators.length;i++)array[mutators[i]]=function(mutator){return function(){return self.mutator.call(self,this,arguments,mutator)}}(mutators[i]);return array.undo=function(n){return self.undoAndRedo.call(this,n,self,!1)},array.redo=function(n){return self.undoAndRedo.call(this,n,self,!0)},array.canUndo=function(n){return!!self.versions[self.currentVersion-(n||1)]},array.canRedo=function(n){return!!self.versions[self.currentVersion+(n||1)]},array.withPersistence=function(store){var instance=this;self.persistence=new Persistence(store);var store=self.persistence.load();return store.store&&store.versions&&store.currentVersion&&(self.store=store.store,self.versions=store.versions,self.currentVersion=store.currentVersion,Array.prototype.splice.call(instance,0,instance.length),Array.prototype.push.apply(instance,self.replaceKeysWithValues(self.versions[self.currentVersion]))),array.clearPersistence=function(){versions=[[]],currentVersion=0,store={},this.splice(0,this.length),self.persistence.clear()},array},array.canUndo=function(n){return!!self.versions[self.currentVersion-(n||1)]},array.canRedo=function(n){return!!self.versions[self.currentVersion+(n||1)]},array.clear=function(){self.newVersion(),this.splice(0,this.length)},array};return UndoManager.prototype.undoAndRedo=function(n,self,direction){if(direction===!0&&!this.canRedo(n)||direction===!1&&!this.canUndo(n))return!1;self.currentVersion=direction?self.currentVersion+(n||1):self.currentVersion-(n||1),Array.prototype.splice.call(this,0,this.length);var newValue=self.persistence?self.replaceKeysWithValues(self.versions[self.currentVersion]):self.versions[self.currentVersion];return Array.prototype.push.apply(this,newValue)},UndoManager.prototype.mutator=function(context,arguments,method){this.versions.length>this.currentVersion&&this.versions.splice(this.currentVersion+1),this.newVersion(),method!="sort"&&Array.prototype[method].apply(context,arguments);if(this.persistence){if(/^(splice|pop)$/.test(method))if(method=="splice"&&arguments.length>2){var startIndex=arguments[0],itemsToRemove=arguments[1],additions=this.replaceValuesWithKeys(Array.prototype.splice.call(arguments,2,arguments.length));additions.unshift(startIndex,itemsToRemove);var result=Array.prototype.splice.apply(this.versions[this.currentVersion],additions)}else{var result=Array.prototype[method].apply(this.versions[this.currentVersion],arguments);result=this.replaceKeysWithValues(result)}else if(method=="reverse"){var result=Array.prototype.reverse.apply(this.versions[this.currentVersion]);result=this.replaceKeysWithValues(result)}else if(method=="sort"){var values=this.replaceKeysWithValues(this.versions[this.currentVersion]),result=Array.prototype.sort.apply(values,arguments);Array.prototype.splice.call(context,0,context.length),Array.prototype.push.apply(context,values),this.versions[this.currentVersion]=this.replaceValuesWithKeys(values)}else var result=Array.prototype[method].apply(this.versions[this.currentVersion],this.replaceValuesWithKeys(arguments));this.persistence.save({versions:this.versions,currentVersion:this.currentVersion,store:this.store})}else var result=Array.prototype[method].apply(this.versions[this.currentVersion],arguments);return result},UndoManager.prototype.replaceValuesWithKeys=function(value){var keys=[];for(var i=0;i<value.length;i++){var key=this.generateHash(value[i]);this.store[key]=value[i],keys.push(key)}return keys},UndoManager.prototype.replaceKeysWithValues=function(keys){var values=[],keys=keys instanceof Array?keys:[keys];for(var i=0;i<keys.length;i++)values.push(this.store[keys[i]]);return values},UndoManager.prototype.generateHash=function(value){var toString=function(value){var string="";if(typeof value=="object"){if(value instanceof Array){if(!/\[object .*?\]/.test(value.join("")))return value.join("");for(var i=0;i<value.length;i++)string+=i+toString(value[i])}else for(var i in value)string+=i+toString(value[i]);return string}return value?value.toString():string+value};return MD5(toString(value))},UndoManager.prototype.newVersion=function(){var version=function(currentVersion){var fork=[];for(var i=0;i<currentVersion.length;i++)fork.push(currentVersion[i]);return fork}(this.versions[this.currentVersion]);this.versions.push(version),this.currentVersion++},UndoManager})
define(["require","../../foundation"],function(require){var stylesheet=document.createElement('link');stylesheet.setAttribute('type','text/css');stylesheet.setAttribute('rel','stylesheet');stylesheet.setAttribute('href',require.toUrl("./modal.css"));document.head.appendChild(stylesheet);function ModalDialogue(){if(!document.getElementById('ModalDialogueOverlay')){this.overlay=document.createElement('div');this.overlay.setAttribute('id','ModalDialogueOverlay');document.body.appendChild(this.overlay)}else{this.overlay=document.getElementById('ModalDialogueOverlay')}}function isValidMDO(MDO){if(typeof MDO=="object"&&!(MDO instanceof Array)){if(!MDO.title||!MDO.body)return false;if(MDO.isWizardDialogue){if(!MDO.buttons)return false;else{if(!MDO.buttons.next&&!MDO.buttons.prev&&!MDO.buttons.close)return false}}return true}}function createDialogueElement(MDO,overlay){var self=this;if(isValidMDO(MDO)){if(overlay)this.overlay=overlay;var dialogue=this.dialogue=document.createElement("div");var dialogueId=(MDO.customId)?MDO.customId:"ModalDialogue";dialogue.setAttribute("id",dialogueId);var classes=['visible'];if(MDO.errorDialogue)classes.push('error');if(MDO.alignment&&/^(center|right)$/.test(MDO.alignment)){classes.push(MDO.alignment)}var title=document.createElement('h1');title.innerHTML=MDO.title;dialogue.appendChild(title);if(!(MDO.body instanceof Array)){MDO.body=[MDO.body]}for(var i=0;i<MDO.body.length;i++){if(MDO.body[i]instanceof HTMLElement){dialogue.appendChild(MDO.body[i])}else if(typeof MDO.body[i]=="string"){if(!(/\<.+\>.*\<.+\>/.test(MDO.body[i])))MDO.body[i]="<p>"+MDO.body[i]+"</p>";dialogue.innerHTML+=MDO.body[i]}}if(MDO.form){classes.push('form');var form=document.createElement('form');form.setAttribute('name',MDO.form.name);form.setAttribute('method','post');for(var i=0;i<MDO.form.inputs.length;i++){if(MDO.form.inputs[i].title){var label=document.createElement('label');label.innerHTML=MDO.form.inputs[i].title}if(MDO.form.inputs[i].type&&MDO.form.inputs[i].type=="select"){var input=document.createElement("select");for(var j=0;j<MDO.form.inputs[i].options.length;j++){var option=document.createElement("option");option.setAttribute('value',MDO.form.inputs[i].options[j]);option.innerHTML=MDO.form.inputs[i].options[j];input.appendChild(option)}if(MDO.form.inputs[i].placeholder){input.value=MDO.form.inputs[i].placeholder}}else{var input=document.createElement('input');if(MDO.form.inputs[i].name){input.setAttribute("name",MDO.form.inputs[i].name)}else{input.setAttribute("name"+"input"+(i+1))}if(MDO.form.inputs[i].type){input.setAttribute("type",MDO.form.inputs[i].type)}else{input.setAttribute("type","text")}if(MDO.form.inputs[i].placeholder){if("placeholder"in input){input.setAttribute('placeholder',MDO.form.inputs[i].placeholder)}else{input.value=MDO.form.inputs[i].placeholder;input.setAttribute('placeholder',MDO.form.inputs[i].placeholder);addListener(input,'focus',function(e){var target=e.target||e.srcElement;if(target.getAttribute('placeholder')==target.value){target.value=""}});addListener(input,'blur',function(e){var target=e.target||e.srcElement;if(target.value==""){target.value=target.getAttribute('placeholder')}})}}}if(label){label.appendChild(input);form.appendChild(label)}else form.appendChild(input)}dialogue.appendChild(form)}if(MDO.buttons){var buttonContainer=document.createElement('div');buttonContainer.setAttribute('class','buttons');for(var i in MDO.buttons){var button=document.createElement('button');if(/close/i.test(i)&&!(typeof MDO.buttons[i]=="function")){button.innerHTML='Close';if(typeof MDO.buttons[i]=="function"){addListener(button,'click',function(){MDO.buttons[i].call(self)})}else{addListener(button,'click',function(){self.destroy()})}}else if(typeof MDO.buttons[i]=="object"){button.innerHTML=MDO.buttons[i].title||i;if(typeof MDO.buttons[i].callback=="function"){if(MDO.isWizardDialogue){var index=parseInt(MDO.customId.match(/\d/)[0]);if(i=="next"){addListener(button,'click',function(e){MDO.buttons.next.callback.call(MDO.buttons.next.callbackContext,e,index)})}if(i=="prev"){addListener(button,'click',function(e){MDO.buttons.prev.callback.call(MDO.buttons.prev.callbackContext,e,index)})}}else{addListener(button,'click',MDO.buttons[i].callback)}}}else if(typeof MDO.buttons[i]=='function'){button.innerHTML=i;addListener(button,'click',function(){MDO.buttons[i].call(self)})}else continue;buttonContainer.appendChild(button)}if(buttonContainer.children.length!=0){dialogue.appendChild(buttonContainer)}else buttonContainer=null}if(MDO.class){if(MDO.class instanceof Array){classes=MDO.class.concat(classes)}else if(typeof MDO.class=="string"){classes.push(MDO.class)}}dialogue.setAttribute('class',classes.join(' '));return dialogue}else{throw{"message":"The specified MDO is invalid.","name":"MDO_FAULT"}}return null}createDialogueElement.prototype.destroy=function(){removeNode(this.dialogue);this.overlay.removeAttribute('class')}ModalDialogue.prototype.createDialogue=function(MDO){if(isValidMDO(MDO)){var dialogue=new createDialogueElement(MDO,this.overlay);if(this.overlay.children.length>=1){removeNode(this.overlay.children[0])}this.overlay.appendChild(dialogue);this.overlay.setAttribute('class','visible')}else console.error('ModalDialogue::createDialogue - No MDO!');return this}ModalDialogue.prototype.createWizard=function(MDOArray){var panes=[];var wizard=document.createElement('div');wizard.setAttribute('id','ModalDialogue');for(var i=0;i<MDOArray.length;i++){MDOArray[i].customId="WizardDialogue"+(i+1);MDOArray[i].isWizardDialogue=true;if(!isValidMDO(MDOArray[i])){console.error("MDO "+(i+1)+" is invalid.");return}if(typeof MDOArray[i].buttons.next=="boolean"){MDOArray[i].buttons.next={"title":"Next","callback":function(e,i){removeNode(wizard.children[0]);wizard.appendChild(panes[i])},"callbackContext":this}}if(typeof MDOArray[i].buttons.prev=="boolean"){MDOArray[i].buttons.prev={"title":"Previous","callback":function(e,i){removeNode(wizard.children[0]);wizard.appendChild(panes[i-2])},"callbackContext":this}}var dialogue=new createDialogueElement(MDOArray[i],this.overlay);panes.push(dialogue)}wizard.appendChild(panes[0]);this.overlay.appendChild(wizard);this.overlay.setAttribute('class','visible')}ModalDialogue.prototype.createDialogueWithSidebar=function(dialogueDefinition){var self=this;if(dialogueDefinition){var dialogue=document.createElement('div');dialogue.setAttribute('id','ModalDialogue');dialogue.setAttribute('class','sidebar');var nav=document.createElement('div');nav.setAttribute('class','navigation');var navItems=document.createElement('ol');var viewContainer=document.createElement('div');viewContainer.setAttribute('class','views');var views=this.views=[];var currentViewIndex=this.currentViewIndex=0;dialogue.appendChild(nav);dialogue.appendChild(viewContainer);if(dialogueDefinition.title){var title=document.createElement('h1');title.innerHTML=dialogueDefinition.title;nav.appendChild(title)}if(dialogueDefinition.views){function switchView(e){var t=e.target||e.srcElement;if(!(currentViewIndex==t.getAttribute('data-viewIndex'))){removeNode(views[currentViewIndex]);viewContainer.appendChild(views[parseInt(t.getAttribute('data-viewIndex'))]);navItems.children[currentViewIndex].removeAttribute('class');currentViewIndex=parseInt(t.getAttribute('data-viewIndex'));navItems.children[currentViewIndex].setAttribute('class','active')}}if(dialogueDefinition.views.length==0){console.error("dialogueDefinition has no views. Cannot continue.");return false}for(var i=0;i<dialogueDefinition.views.length;i++){if(isValidMDO(dialogueDefinition.views[i])){dialogueDefinition.views[i].customId="ModalView"+(i+1);dialogueDefinition.views[i].class="view";if(dialogueDefinition.views[i].buttons){delete dialogueDefinition.views[i].buttons}var view=createDialogueElement(dialogueDefinition.views[i],this.overlay);view.setAttribute('data-viewIndex',i);views.push(view);var navItem=document.createElement('li');navItem.innerHTML=dialogueDefinition.views[i].navTitle||dialogueDefinition.views[i].title;navItem.setAttribute('data-viewIndex',i);addListener(navItem,'click',function(e){switchView.call(self,e)});if(i==0)navItem.setAttribute('class','active');navItems.appendChild(navItem)}else{console.error("Invalid view. Choked on DMO "+(i+1));return false}}viewContainer.appendChild(views[0])}if(dialogueDefinition.buttons){self.destroy=function(){removeNode(this.overlay)}var buttonContainer=document.createElement('div');buttonContainer.setAttribute('class','buttons');for(var i in dialogueDefinition.buttons){var button=document.createElement('button');if(i=="close"){button.innerHTML="Close";addListener(button,'click',function(){self.destroy()})}else{button.innerHTML=i;if(typeof dialogueDefinition.buttons[i]=="function"){addListener(button,'click',function(e){dialogueDefinition.buttons[i].call(self,e)})}}buttonContainer.appendChild(button)}viewContainer.appendChild(buttonContainer)}this.overlay.appendChild(dialogue);this.overlay.setAttribute('class','visible');nav.appendChild(navItems);return dialogue}else return false}return ModalDialogue});
define(["require","../../foundation"],function(a){function e(a,b){var c=this;if(d(a)){if(b)this.overlay=b;var e=this.dialogue=document.createElement("div");var f=a.customId?a.customId:"ModalDialogue";e.setAttribute("id",f);var g=["visible"];if(a.errorDialogue)g.push("error");if(a.alignment&&/^(center|right)$/.test(a.alignment)){g.push(a.alignment)}var h=document.createElement("h1");h.innerHTML=a.title;e.appendChild(h);if(!(a.body instanceof Array)){a.body=[a.body]}for(var i=0;i<a.body.length;i++){if(a.body[i]instanceof HTMLElement){e.appendChild(a.body[i])}else if(typeof a.body[i]=="string"){if(!/\<.+\>.*\<.+\>/.test(a.body[i]))a.body[i]="<p>"+a.body[i]+"</p>";e.innerHTML+=a.body[i]}}if(a.form){g.push("form");var j=document.createElement("form");j.setAttribute("name",a.form.name);j.setAttribute("method","post");for(var i=0;i<a.form.inputs.length;i++){if(a.form.inputs[i].title){var k=document.createElement("label");k.innerHTML=a.form.inputs[i].title}if(a.form.inputs[i].type&&a.form.inputs[i].type=="select"){var l=document.createElement("select");for(var m=0;m<a.form.inputs[i].options.length;m++){var n=document.createElement("option");n.setAttribute("value",a.form.inputs[i].options[m]);n.innerHTML=a.form.inputs[i].options[m];l.appendChild(n)}if(a.form.inputs[i].placeholder){l.value=a.form.inputs[i].placeholder}}else{var l=document.createElement("input");if(a.form.inputs[i].name){l.setAttribute("name",a.form.inputs[i].name)}else{l.setAttribute("name"+"input"+(i+1))}if(a.form.inputs[i].type){l.setAttribute("type",a.form.inputs[i].type)}else{l.setAttribute("type","text")}if(a.form.inputs[i].placeholder){if("placeholder"in l){l.setAttribute("placeholder",a.form.inputs[i].placeholder)}else{l.value=a.form.inputs[i].placeholder;l.setAttribute("placeholder",a.form.inputs[i].placeholder);addListener(l,"focus",function(a){var b=a.target||a.srcElement;if(b.getAttribute("placeholder")==b.value){b.value=""}});addListener(l,"blur",function(a){var b=a.target||a.srcElement;if(b.value==""){b.value=b.getAttribute("placeholder")}})}}}if(k){k.appendChild(l);j.appendChild(k)}else j.appendChild(l)}e.appendChild(j)}if(a.buttons){var o=document.createElement("div");o.setAttribute("class","buttons");for(var i in a.buttons){var p=document.createElement("button");if(/close/i.test(i)&&!(typeof a.buttons[i]=="function")){p.innerHTML="Close";if(typeof a.buttons[i]=="function"){addListener(p,"click",function(){a.buttons[i].call(c)})}else{addListener(p,"click",function(){c.destroy()})}}else if(typeof a.buttons[i]=="object"){p.innerHTML=a.buttons[i].title||i;if(typeof a.buttons[i].callback=="function"){if(a.isWizardDialogue){var q=parseInt(a.customId.match(/\d/)[0]);if(i=="next"){addListener(p,"click",function(b){a.buttons.next.callback.call(a.buttons.next.callbackContext,b,q)})}if(i=="prev"){addListener(p,"click",function(b){a.buttons.prev.callback.call(a.buttons.prev.callbackContext,b,q)})}}else{addListener(p,"click",a.buttons[i].callback)}}}else if(typeof a.buttons[i]=="function"){p.innerHTML=i;addListener(p,"click",function(){a.buttons[i].call(c)})}else continue;o.appendChild(p)}if(o.children.length!=0){e.appendChild(o)}else o=null}if(a.class){if(a.class instanceof Array){g=a.class.concat(g)}else if(typeof a.class=="string"){g.push(a.class)}}e.setAttribute("class",g.join(" "));return e}else{throw{message:"The specified MDO is invalid.",name:"MDO_FAULT"}}return null}function d(a){if(typeof a=="object"&&!(a instanceof Array)){if(!a.title||!a.body)return false;if(a.isWizardDialogue){if(!a.buttons)return false;else{if(!a.buttons.next&&!a.buttons.prev&&!a.buttons.close)return false}}return true}}function c(){if(!document.getElementById("ModalDialogueOverlay")){this.overlay=document.createElement("div");this.overlay.setAttribute("id","ModalDialogueOverlay");document.body.appendChild(this.overlay)}else{this.overlay=document.getElementById("ModalDialogueOverlay")}}var b=document.createElement("link");b.setAttribute("type","text/css");b.setAttribute("rel","stylesheet");b.setAttribute("href",a.toUrl("./modal.css"));document.head.appendChild(b);e.prototype.destroy=function(){removeNode(this.dialogue);this.overlay.removeAttribute("class")};c.prototype.createDialogue=function(a){if(d(a)){var b=new e(a,this.overlay);if(this.overlay.children.length>=1){removeNode(this.overlay.children[0])}this.overlay.appendChild(b);this.overlay.setAttribute("class","visible")}else console.error("ModalDialogue::createDialogue - No MDO!");return this};c.prototype.createWizard=function(a){var b=[];var c=document.createElement("div");c.setAttribute("id","ModalDialogue");for(var f=0;f<a.length;f++){a[f].customId="WizardDialogue"+(f+1);a[f].isWizardDialogue=true;if(!d(a[f])){console.error("MDO "+(f+1)+" is invalid.");return}if(typeof a[f].buttons.next=="boolean"){a[f].buttons.next={title:"Next",callback:function(a,d){removeNode(c.children[0]);c.appendChild(b[d])},callbackContext:this}}if(typeof a[f].buttons.prev=="boolean"){a[f].buttons.prev={title:"Previous",callback:function(a,d){removeNode(c.children[0]);c.appendChild(b[d-2])},callbackContext:this}}var g=new e(a[f],this.overlay);b.push(g)}c.appendChild(b[0]);this.overlay.appendChild(c);this.overlay.setAttribute("class","visible")};c.prototype.createDialogueWithSidebar=function(a){var b=this;if(a){var c=document.createElement("div");c.setAttribute("id","ModalDialogue");c.setAttribute("class","sidebar");var f=document.createElement("div");f.setAttribute("class","navigation");var g=document.createElement("ol");var h=document.createElement("div");h.setAttribute("class","views");var i=this.views=[];var j=this.currentViewIndex=0;c.appendChild(f);c.appendChild(h);if(a.title){var k=document.createElement("h1");k.innerHTML=a.title;f.appendChild(k)}if(a.views){function l(a){var b=a.target||a.srcElement;if(!(j==b.getAttribute("data-viewIndex"))){removeNode(i[j]);h.appendChild(i[parseInt(b.getAttribute("data-viewIndex"))]);g.children[j].removeAttribute("class");j=parseInt(b.getAttribute("data-viewIndex"));g.children[j].setAttribute("class","active")}}if(a.views.length==0){console.error("dialogueDefinition has no views. Cannot continue.");return false}for(var m=0;m<a.views.length;m++){if(d(a.views[m])){a.views[m].customId="ModalView"+(m+1);a.views[m].class="view";if(a.views[m].buttons){delete a.views[m].buttons}var n=e(a.views[m],this.overlay);n.setAttribute("data-viewIndex",m);i.push(n);var o=document.createElement("li");o.innerHTML=a.views[m].navTitle||a.views[m].title;o.setAttribute("data-viewIndex",m);addListener(o,"click",function(a){l.call(b,a)});if(m==0)o.setAttribute("class","active");g.appendChild(o)}else{console.error("Invalid view. Choked on DMO "+(m+1));return false}}h.appendChild(i[0])}if(a.buttons){b.destroy=function(){removeNode(this.overlay)};var p=document.createElement("div");p.setAttribute("class","buttons");for(var m in a.buttons){var q=document.createElement("button");if(m=="close"){q.innerHTML="Close";addListener(q,"click",function(){b.destroy()})}else{q.innerHTML=m;if(typeof a.buttons[m]=="function"){addListener(q,"click",function(c){a.buttons[m].call(b,c)})}}p.appendChild(q)}h.appendChild(p)}this.overlay.appendChild(c);this.overlay.setAttribute("class","visible");f.appendChild(g);return c}else return false};return c})